#!/bin/bash
 
source experimentconfig.sh


#Generate source point file
python ${EXPERIMENTFOLDER}/loop_functions/generate_source_pos.py

echo "+-----------------------------------------------------------+"
echo "Updating the Smart Contract"

sed -e "s|MAXRECRUITS|$MAXRECRUITS|g"\
  $SCFILE > $SCTEMPLATE

sed -e "s|NUMPT|$NUMPT|g;s|MAXLIFE|$MAXLIFE|g;s|MINREP|$MINREP|g;s|RADIUS|$RADIUS|g;s|MINBALANCE|$MINBALANCE|g"\
  $SCFILE > $SCTEMPLATE


echo "+-----------------------------------------------------------+"
echo "Compiling the Smart Contract"

# Compile smart contract
solc --overwrite --abi --bin-runtime -o  "${EXPERIMENTFOLDER}/scs/build/" $SCTEMPLATE
cp -r "${EXPERIMENTFOLDER}/scs/build/." "${DOCKERFOLDER}/geth/deployed_contract/"

BINDATA=`cat ${CONTRACTBIN}`

echo "+-----------------------------------------------------------+"
echo "Generating the Genesis block"

# Create genesis using puppeth
bash ${DOCKERFOLDER}/geth/files/reset-genesis ${NUMROBOTS} $BLOCKPERIOD

# Insert the smart contract into the genesis 
sed -ie "s|123\": {|123\": {\n\"code\": \"0xBINDATA\",|g" ${GENESISFILE}
sed -ie "s|BINDATA|$BINDATA|g" ${GENESISFILE}
# Change the gas limit
sed -ie "s|0x47b760|0x9000000000000|g" ${GENESISFILE}
# Change the value of the pre-funded accounts
sed -ie "s|\"0x200000000000000000000000000000000000000000000000000000000000000\"|\"0x1236efcbcbb340000\"|g" ${GENESISFILE}
# # Undo for the contract account (first match)
sed -ie "0,/\"0x1236efcbcbb340000\"/s//\"0x200000000000000000000000000000000000000000000000000000000000000\"/" ${GENESISFILE}

# 0x1236efcbcbb340000 = 21 ether
# 0xde0b6b3a7640000 = 1 ether

echo "+-----------------------------------------------------------+"
echo "Restarting the docker containers"


## Restart docker
docker service scale ethereum_eth=0
echo "Shuting down docker process..."
bash ${DOCKERFOLDER}/local_scripts/stop_network.sh $NUMROBOTS

echo "Starting new docker process..."
sudo systemctl restart docker.service
bash ${DOCKERFOLDER}/local_scripts/start_network.sh $NUMROBOTS

echo "+-----------------------------------------------------------+"
echo "Creating the identifier file"

## Create identifiers file
# Get IDs
seq 1 $NUMROBOTS > temp0.txt
# Get containers
docker ps --format '{{.Names}} {{.ID}}' > temp1.txt
sort -o temp1.txt temp1.txt
# Get IPs
./bash-all -s "ip a" | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" | grep "172." | grep -v ".255" > temp2.txt
./bash-all -s "ip a" | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" | grep "10.0.1" | grep -v ".255" > temp3.txt
# Save to identifiers file
paste temp0.txt temp1.txt temp2.txt temp3.txt > identifiers.txt
rm temp0.txt temp1.txt temp2.txt temp3.txt
