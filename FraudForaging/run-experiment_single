#!/bin/bash
# Iterate over experimental settings and start experiments
source experimentconfig_single.sh
DATAFOLDER="$EXPERIMENTFOLDER/results/data"

##################################################################################
### EXAMPLE: config "NUMROBOTS" 10 
config() {
	sed -i "s/^export ${1}=.*/export ${1}=${2}/" experimentconfig_single.sh
}

##################################################################################
### EXAMPLE: copy "test116_patchy/20_blockchain1"
copy() {
	# Collect the config from results
	cp $DATAFOLDER/experiment_${1}/001/experimentconfig_single.sh .
	cp $DATAFOLDER/experiment_${1}/001/controller_params.py controllers/
	cp $DATAFOLDER/experiment_${1}/001/loop_function_params.py loop_functions/
}

##################################################################################
### EXAMPLE: import "test116_patchy/20_blockchain1"
import() {
	# Collect the config from results
	SSHHOST="eksander@esme"
	SSHSOCKET=~/.ssh/$SSHHOST
	
	ssh -M -f -N -o ControlPath=$SSHSOCKET $SSHHOST
	scp -o ControlPath=$SSHSOCKET $SSHHOST:$DATAFOLDER/experiment_${1}/001/experimentconfig_single.sh .
	scp -o ControlPath=$SSHSOCKET $SSHHOST:$DATAFOLDER/experiment_${1}/001/controller_params.py controllers/
	scp -o ControlPath=$SSHSOCKET $SSHHOST:$DATAFOLDER/experiment_${1}/001/loop_function_params.py loop_functions/
	ssh -S $SSHSOCKET -O exit $SSHHOST
}

##################################################################################
### EXAMPLE: run "test116_patchy/20_blockchain1"
run() {

	# Configure experiment
	. experimentconfig_single.sh


	for REP in $(seq 1 ${REPS}); do
	  #Generate source point file
    python3 ${EXPERIMENTFOLDER}/loop_functions/generate_source_pos.py

		# Perform experiment
		#. starter --reset-geth --start-novis
		. starter_single --reset-geth --start-novis

		# Collect data
		if [ $# -eq 1 ]; then
		    bash collect-logs_single ${1}
		fi
		
	done
}

export USEWMSR=3 #wmsr excluding 3 pts
export NUM1A=15
export NUM2=0
config "REPS" 10
run "SingleSourceSupp/wmsr_3_0_15_lnb"



export USEWMSR=3 #wmsr excluding 3 pts
export NUM1A=14
export NUM2=1
config "REPS" 10
run "SingleSourceSupp/wmsr_3_1_15_lnb"

export USEWMSR=3 #wmsr excluding 3 pts
export NUM1A=13
export NUM2=2
config "REPS" 10
run "SingleSourceSupp/wmsr_3_2_15_lnb"

export USEWMSR=3 #wmsr excluding 3 pts
export NUM1A=12
export NUM2=3
config "REPS" 10
run "SingleSourceSupp/wmsr_3_3_15_lnb"

export USEWMSR=3 #wmsr excluding 3 pt#s
export NUM1A=11
export NUM2=4
config "REPS" 10
run "SingleSourceSupp/wmsr_3_4_15_lnb"

#export USEWMSR=3 #wmsr excluding 3 pts
#export NUM1A=10
#export NUM2=5
#config "REPS" 15
#run "SingleSourceSupp/wmsr_3_5_15_lnb"
#
#
#export USEWMSR=0 #wmsr excluding 3 pts
#export NUM1A=15
#export NUM2=0
#config "REPS" 15
#run "SingleSourceSupp/lca_3_0_15_lnb"


export USEWMSR=0
export NUM1A=14
export NUM2=1
config "REPS" 10
run "SingleSourceSupp/lca_3_1_15_lnb"

export USEWMSR=0
export NUM1A=13
export NUM2=2
config "REPS" 10
run "SingleSourceSupp/lca_3_2_15_lnb"

export USEWMSR=0
export NUM1A=12
export NUM2=3
config "REPS" 10
run "SingleSourceSupp/lca_3_3_15_lnb"

export USEWMSR=0
export NUM1A=11
export NUM2=4
config "REPS" 10
run "SingleSourceSupp/lca_3_4_15_lnb"
#
#export USEWMSR=0
#export NUM1A=10
#export NUM2=5
#config "REPS" 15
#run "SingleSourceSupp/lca_3_5_15_lnb"





